<!DOCTYPE html>
<html lang="zh">
<head>
    <title>test</title>
</head>
<body>

</body>
<script src="../js/jquery-3.3.1.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">


    let manager = new DataManager();

    let host = "http://localhost:8089";

    /**
     * 加载科目数据
     * */
    function loadSubject(para) {

            $.ajax({
                url: host + "/api/account/voucherSummary/v1/getSubject.do",
                type: "post",
                data: para,
                success: function (res) {
                    manager.setData("subject", res.data);
                },
                error: function () {
                    //todo
                }
            });

    }

    /**
     * 加载分录
     * */
    function loadSummary(para) {
        $.ajax({
            url: host + "/api/account/voucherSummary/v1/getSummaryList.do",
            type: "post",
            data: para,
            success: function (res) {
                manager.setData("summary", res.data);
            },
            error: function () {
                //todo
            }
        });
    }

    function DataManager() {
        let $datas = {}, $events = [], $args = {};

        function check(tartget) {
            let targets, para, arg, once;
            for (let key in $events) {

                if (key.indexOf(tartget) > -1) {
                    targets = key.split(",");
                    //检查所需数据是否齐全
                    para = {};
                    for (let t of targets) {
                        arg = $datas[t];
                        if (arg === undefined) return;
                        para[t] = arg;
                    }

                    //执行回调
                    let eventSet = $events[key];
                    for (let event of eventSet) {
                        event(para);

                    }

                    //检查是否重置数据
                    for (let t of targets) {
                        once = $args[t];
                        if (once === true) {
                            delete  $datas[t];
                        }
                    }

                }
            }
        }

        /***
         *
         * @param tagert 数据标记
         * @param data 数据
         * @param once 默认false，是否是一次性的、在指定方法调用后是否重置
         */
        this.setData = function (tagert, data, once) {
            $datas[tagert] = data;
            once = once || false;
            $args[tagert] = once;
            check(tagert);
        };
        /**
         *添加事件监听
         * @param listener 事件回调
         * @param targets [string...] 字符数组
         */
        this.addListener = function (targets, listener) {
            if (typeof listener !== "function") {
                console.log("listener should be a function !")
                return;
            }
            if (Array.isArray(targets) && targets.length < 1) {
                console.log("targets should be a Array ,and length greater than zero !")
                return;
            }
            let key = targets.join(",");
            let eventSet = $events[key] || new Set();
            eventSet.add(listener);
            $events[key] = eventSet;

        };

    }


</script>
<script type="text/javascript">

    manager.addListener(["subject", "summary"], function (datas) {
        let subject = datas["subject"], summary = datas["summary"];

        let filter = {start: 1, end: 1};
        //获取对应层级
        let level, ret = [];
        for (let sub of subject) {
            level = parseInt(sub["level"]);
            if (level < filter.start || level > filter.end) continue;
            sub.debitAmount = 0;
            sub.creditAmount = 0;
            ret.push(sub);
        }
        //累加聚合数据
        let subjectCode, code, retVal = [], flag;
        for (let sub  of ret) {
            subjectCode = sub["code"].toString();
            flag = false;
            for (let sum of summary) {
                code = sum["subjectCode"];
                if (subjectCode.startsWith(code)) {
                    subject.creditAmount += summary.creditAmount;
                    subject.debitAmount += summary.debitAmount;
                    flag = true;
                }
            }
            //剔除发生额全为0的数据
            if (flag) {
                retVal.push(sub)
            }
        }

        console.log(retVal);

    });

    let para = {TOKEN: 1};
    loadSubject(para);
    loadSummary(para);
</script>
</html>